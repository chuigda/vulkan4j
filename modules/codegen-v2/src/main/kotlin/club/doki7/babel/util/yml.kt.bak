package club.doki7.babel.util

import org.yaml.snakeyaml.Yaml
import java.io.StringReader
import kotlin.collections.Map

fun String.parseYML(): Map<String, Any> {
    val yaml = Yaml()
    return yaml.load(StringReader(this)) as Map<String, Any>
}

fun Map<String, Any>.getAttributeText(name: String): String? =
    this[name]?.toString()

fun Map<String, Any>.getFirstElement(tag: String): Map<String, Any> =
    this[tag] as Map<String, Any>

fun Map<String, Any>.getElementSeq(tag: String): Sequence<Map<String, Any>> =
    (this[tag] as? List<*>)?.filterIsInstance<Map<String, Any>>()?.asSequence() ?: emptySequence()

// XPath 查询（类似功能） - 针对 YAML 结构树
fun Map<String, Any>.query(xpath: String): Sequence<Map<String, Any>> {
    val parts = xpath.split("/")
    var currentNode: Any? = this
    for (part in parts) {
        currentNode = (currentNode as? Map<*, *>)?.get(part)
    }
    return if (currentNode is List<*>) {
        currentNode.filterIsInstance<Map<String, Any>>().asSequence()
    } else {
        emptySequence()
    }
}

fun <T> Map<String, Any>.toList(): List<Map<String, Any>> =
    this.values.filterIsInstance<Map<String, Any>>()

operator fun Map<String, Any>.iterator(): Iterator<Map.Entry<String, Any>> = this.entries.iterator()

fun Map<String, Any>.asSequence(): Sequence<Map.Entry<String, Any>> = this.iterator().asSequence()
